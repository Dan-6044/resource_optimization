{%load static%}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/x-icon" href="{% static 'imG/FPLOGO.png' %}">
    <title>FastPro</title>
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <!-- Nucleo Icons -->
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <!-- Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <!-- CSS Files -->
  <link rel="stylesheet" href="{% static 'css/material-dashboard.css' %}" id="pagestyle">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
     <!-- JustGage CSS -->
  <link href="https://cdn.jsdelivr.net/npm/justgage@1.3.3/justgage.css" rel="stylesheet">

  <!-- Custom CSS to Make Donut Chart Smaller -->
    <style>
        #donutChart {
            width: 220px !important;  /* Adjust width */
            height: 222px !important; /* Adjust height */
            display: block; /* Prevent stretching */
            margin: auto;
        }
    </style>
</head>

<body class="g-sidenav-show  bg-gray-100">
  <!-- SideNav -->
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2  bg-white my-2" id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-dark opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand px-4 py-3 m-0" href=" # " target="_blank"> <span class="ms-1 ">
          <h5 class="text-dark">Fast<span class="text-info">Pro.</span><sub class="text-danger">com</sub></h5>
        </span>
      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-dark {% if request.path == '/home_dashboard/' %}active bg-light text-dark{% endif %}" href="{% url 'home_dashboard' user_id=user.id %}">
            <i class="material-symbols-rounded opacity-5">home</i>
            <span class="nav-link-text ms-1">Home</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark {% if request.path == '/my_work/' %}active bg-light text-dark{% endif %}" href="{% url 'my_work'  user_id=user.id%}">
            <i class="material-symbols-rounded opacity-5">work</i>
            <span class="nav-link-text ms-1">My Work</span>
          </a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link text-dark {% if request.path == '/emailing/' %}active bg-light text-dark{% endif %}"  href="{% url 'emailing'  user_id=user.id %}">          
            <i class="material-symbols-rounded opacity-5">email</i>
            <span class="nav-link-text ms-1">Mass Email Tracking</span>
          </a>
        </li>
        <hr class="horizontal dark mt-0 mb-2">
        <li class="nav-item">
          <a class="nav-link text-dark {% if request.path == '/dashboard/' %}active bg-light text-dark{% endif %}"  href="{% url 'dashboard'  user_id=user.id%}">          
            <i class="material-symbols-rounded opacity-5">star</i>
            <span class="nav-link-text ms-1">Favorites</span>
          </a>
        </li>
        <hr class="horizontal dark mt-0 mb-2">
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5">Work Spaces</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark {% if request.path == '/projects/' %}active bg-light text-dark{% endif %}"  href="{% url 'create_project'  user_id=user.id%}">          
            <i class="material-symbols-rounded opacity-5">view_list</i>
            <span class="nav-link-text ms-1">Project Pipeline</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark {% if request.path == '/resources/' %}active bg-light text-dark{% endif %}"  href="{% url 'add_resource'  user_id=user.id %}">          
            <i class="material-symbols-rounded opacity-5">construction</i>
            <span class="nav-link-text ms-1">Project Resources</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark {% if request.path == '/dashboard/' %}active bg-light text-dark{% endif %}"  href="{% url 'dashboard'  user_id=user.id %}">           
            <i class="material-symbols-rounded opacity-5">space_dashboard</i>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark {% if request.path == '/billings/' %}active bg-light text-dark{% endif %}"  href="{% url 'billings'  user_id=user.id%}">          
            <i class="material-symbols-rounded opacity-5">payments</i>
            <span class="nav-link-text ms-1">Billing</span>
          </a>
        </li>        
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5">Account pages</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark {% if request.path == '/profile/' %}active bg-light text-dark{% endif %}"  href="{% url 'profile'  user_id=user.id %}">          
            <i class="material-symbols-rounded opacity-5">account_circle</i>
            <span class="nav-link-text ms-1">Profile</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark active"  href="{% url 'logout' %}">          
            <i class="material-symbols-rounded opacity-5">person_add</i>
            <span class="nav-link-text ms-1">Logout</span>
          </a>
        </li>    
       
      </ul>
    </div>
    <div class="sidenav-footer position-absolute w-100 bottom-0 ">
      <div class="mx-3">
        
      </div>
    </div>
  </aside>
   <!-- End of sideNav -->

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">


    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur" data-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Dashboard</li>
          </ol>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
            <div class="input-group input-group-outline">
              <label class="form-label">Type here...</label>
              <input type="text" class="form-control">
            </div>
          </div>
          <ul class="navbar-nav d-flex align-items-center  justify-content-end">
            <li class="nav-item d-flex align-items-center">
              <a class="btn btn-outline-primary btn-sm mb-0 me-3" target="_blank" href="{% url 'pricing' %}">See Plans</a>
            </li>
            <li class="mt-1">
              <a class="github-button" href="#" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star creativetimofficial/material-dashboard on GitHub">Star</a>
            </li>
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>
            <li class="nav-item px-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0">
                <i class="material-symbols-rounded fixed-plugin-button-nav">settings</i>
              </a>
            </li>

            <!-- In your base.html or any template where you want to show task notifications -->
            <li class="nav-item dropdown pe-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="material-symbols-rounded position-relative">
                            <!-- Display notification count if there are notifications -->
                          {% if notifications|length > 0 %}
                          <span class="badge bg-danger badge-pill position-absolute top-0 start-100 translate-middle" style="font-size: 8px; width: 16px; height: 16px; padding: 2px 4px;">
                              {{ notifications|length }}
                          </span>
                      {% endif %}
                      notifications
                  </i>     
              </a>
              <ul class="dropdown-menu dropdown-menu-end px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
                  {% for notification in notifications %}
                  <li class="mb-2">
                      <a class="dropdown-item border-radius-md" href="javascript:;">
                          <div class="d-flex py-1">
                              <div class="my-auto">
                                  <i class="material-symbols-rounded">assignment</i> <!-- Placeholder icon for task -->
                              </div>
                              <div class="d-flex flex-column justify-content-center">
                                  <h6 class="text-sm font-weight-normal mb-1">{{ notification.message }}</h6>
                                  <p class="text-xs text-secondary mb-0">
                                      <i class="fa fa-clock me-1"></i>
                                      {{ notification.time }}
                                  </p>
                              </div>
                          </div>
                      </a>
                  </li>
                  {% endfor %}
              </ul>
            </li>            
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link text-body font-weight-bold px-0" href="{% url 'profile' user_id=user.id %}">            
                <i class="material-symbols-rounded">account_circle</i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>    
    <!-- End Navbar -->





    <!--Main Page-->
     <div class="container-fluid py-2">
    <div class="row">
        <div class="ms-3">
            <h3 class="mb-0 h4 font-weight-bolder">Dashboard</h3>
            <p class="mb-4">Check Resources, value, and bounce rate by Projects.</p>
        </div>

        {% if projects %}
            <div class="row gx-1">
                <!-- First Column -->
                <div class="col-lg-4">
                    <div class="row gx-1">
                        <div class="col-6 gy-0">
                            <div class="card p-2 mb-2 shadow">
                                <label style="font-size: 14px;"><strong>Project Name</strong></label>
                                <select id="projectDropdown" class="form-select" style="font-size: 14px;">
                                    {% for project in projects %}
                                        <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="card p-2 mb-2 shadow gy-0">
                                <label style="font-size: 14px;"><strong>Project Status</strong></label>
                                <input id="projectStatus" type="text" class="form-control" style="font-size: 14px;" readonly>
                            </div>
                            <div class="card p-2 mb-2 shadow text-center text-secondary" style="height: 75px;">
                                <h6 style="margin-bottom: 15px;">Estimated Cost</h6>
                                <p id="estimatedCost" style="font-size: 18px;"></p>
                            </div>
                        </div>

                        <div class="col-6 gy-0">
                            <div class="d-flex flex-column gap-2">
                                <div class="card p-2 shadow flex-fill" style="height: 125px; overflow-y: auto;">
                                    <p style="font-size: 13px;"><strong>Project Name:</strong> <span id="projectName"></span></p>
                                    <p style="font-size: 13px;">Project</p>
                                    <p style="font-size: 12px;"><strong>Start Date:</strong> <span id="startDate"></span></p>
                                    <p style="font-size: 12px;"><strong>End Date:</strong> <span id="endDate"></span></p>
                                </div>
                                <div class="card p-3 shadow flex-fill text-center text-secondary" style="height: 125px;">
                                    <h6>Budget Utilization</h6>
                                    <h2 id="budgetUtilization"></h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row gy-0 mt-0">
                        <div class="col-12">
                            <div class="card p-2 shadow">
                                <div class="d-flex justify-content-between">
                                    <div class="gauge-container" style="width: 40%;">
                                        <h2 style="font-size: 16px;">Schedule Performance</h2>
                                        <div id="schedule-gauge" class="my-2"></div>
                                        <p style="text-align: center; font-size: 1em;">Current Value: <span id="schedulePerformance">0</span></p>
                                    </div>
                                    <div class="gauge-container" style="width: 40%;">
                                        <h2 style="font-size: 18px;">Cost Performance</h2>
                                        <div id="cost-gauge" class="my-2"></div>
                                        <p style="text-align: center; font-size: 1em;">Current Value: <span id="costPerformance">0</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second Column -->
                <div class="col-lg-4 gx-1">
                    <div class="card p-3">
                        <canvas id="donutChart"></canvas>
                    </div>
                    <div class="card p-2 gy-0 mt-2">
                        <div style="max-height: 230px; overflow-y: auto;">
                            <table id="resourceTable" class="table">
                                <thead>
                                    <tr style="font-size: 12px;">
                                        <th>Color</th>
                                        <th>Resource</th>
                                        <th>Cost</th>
                                    </tr>
                                </thead>
                                <tbody style="font-size: 12px;">
                                    <!-- Rows will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Third Column -->
                <div class="col-lg-4">
                    <div class="row g-1">
                        <div class="col-6">
                            <div class="card p-2 shadow d-flex flex-column align-items-center" style="height: 250px;">
                                <canvas id="taskPieChart" style="max-width: 100%; height: 150px;"></canvas>
                                <div id="taskPieLegend" class="d-flex flex-wrap justify-content-center mt-2" style="max-height: 50px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card p-2 shadow d-flex flex-column align-items-center" style="height: 250px;">
                                <canvas id="barChart" style="max-width: 100%; height: 150px;"></canvas>
                                <div id="barLegend" class="d-flex flex-wrap justify-content-center mt-2" style="max-height: 50px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-1 mt-2">
                        <div class="col-12">
                            <div class="card p-2 shadow" style="height: 250px;">
                                <canvas id="lineChart" style="max-width: 100%; height: 150px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="col-12 text-center">
                <div class="alert alert-warning mt-4 p-4">
                    <h5>No projects available</h5>
                    <p>Please add projects to view dashboard insights.</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

      
    
      
      <footer class="footer py-4  ">
        <div class="container-fluid">
          <div class="row align-items-center justify-content-lg-between">
            <div class="col-lg-6 mb-lg-0 mb-4">
              <div class="copyright text-center text-sm text-muted text-lg-start">
                © <script>
                  document.write(new Date().getFullYear())
                </script>,
                made with <i class="fa fa-heart"></i> by
                <a href="#" class="font-weight-bold">Elite Coders</a>
                for a better web.
              </div>
            </div>
            <div class="col-lg-6">
              <ul class="nav nav-footer justify-content-center justify-content-lg-end">
                <li class="nav-item">
                  <a href="#" class="nav-link text-muted" >Fast Pro</a>
                </li>
                <li class="nav-item">
                  <a href="#" class="nav-link text-muted">About Us</a>
                </li>
                <li class="nav-item">
                  <a href="#" class="nav-link text-muted">Blog</a>
                </li>
                <li class="nav-item">
                  <a href="#" class="nav-link pe-0 text-muted" >License</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </main>
  <div class="fixed-plugin">
    <a class="fixed-plugin-button text-dark position-fixed px-3 py-2">
      <i class="material-symbols-rounded py-2">settings</i>
    </a>
    <div class="card shadow-lg">
      <div class="card-header pb-0 pt-3">
        <div class="float-start">
          <h5 class="mt-3 mb-0">Material UI Configurator</h5>
          <p>See our dashboard options.</p>
        </div>
        <div class="float-end mt-4">
          <button class="btn btn-link text-dark p-0 fixed-plugin-close-button">
            <i class="material-symbols-rounded">clear</i>
          </button>
        </div>
        <!-- End Toggle Button -->
      </div>
      <hr class="horizontal dark my-1">
      <div class="card-body pt-sm-3 pt-0">
        <!-- Sidebar Backgrounds -->
        <div>
          <h6 class="mb-0">Sidebar Colors</h6>
        </div>
        <a href="javascript:void(0)" class="switch-trigger background-color">
          <div class="badge-colors my-2 text-start">
            <span class="badge filter bg-gradient-primary" data-color="primary" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-dark active" data-color="dark" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-info" data-color="info" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-success" data-color="success" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-warning" data-color="warning" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-danger" data-color="danger" onclick="sidebarColor(this)"></span>
          </div>
        </a>
        <!-- Sidenav Type -->
        <div class="mt-3">
          <h6 class="mb-0">Sidenav Type</h6>
          <p class="text-sm">Choose between different sidenav types.</p>
        </div>
        <div class="d-flex">
          <button class="btn bg-gradient-dark px-3 mb-2" data-class="bg-gradient-dark" onclick="sidebarType(this)">Dark</button>
          <button class="btn bg-gradient-dark px-3 mb-2 ms-2" data-class="bg-transparent" onclick="sidebarType(this)">Transparent</button>
          <button class="btn bg-gradient-dark px-3 mb-2  active ms-2" data-class="bg-white" onclick="sidebarType(this)">White</button>
        </div>
        <p class="text-sm d-xl-none d-block mt-2">You can change the sidenav type just on desktop view.</p>
        <!-- Navbar Fixed -->
        <div class="mt-3 d-flex">
          <h6 class="mb-0">Navbar Fixed</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="navbarFixed" onclick="navbarFixed(this)">
          </div>
        </div>
        <hr class="horizontal dark my-3">
        <div class="mt-2 d-flex">
          <h6 class="mb-0">Light / Dark</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="dark-version" onclick="darkMode(this)">
          </div>
        </div>
        <hr class="horizontal dark my-sm-4">
        <div class="w-100 text-center">
          <a class="github-button" href="#" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star creativetimofficial/material-dashboard on GitHub">Star</a>
          <h6 class="mt-3">Thank you for sharing!</h6>
          <a href="#" class="btn btn-dark mb-0 me-2">
            <i class="fab fa-twitter me-1" aria-hidden="true"></i> Tweet
          </a>
          <a href="#" target="_blank">
            <i class="fab fa-facebook-square me-1" aria-hidden="true"></i> Share
          </a>
        </div>
      </div>
    </div>
  </div>




  <!-- Project Details Script -->
  <script src="https://cdn.jsdelivr.net/npm/justgage@1.3.0/justgage.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let dropdown = document.getElementById("projectDropdown");
        let statusField = document.getElementById("projectStatus");
        let costField = document.getElementById("estimatedCost");
        let projectNameField = document.getElementById("projectName");
        let startDateField = document.getElementById("startDate");
        let endDateField = document.getElementById("endDate");
        let budgetUtilizationField = document.getElementById("budgetUtilization");
        let schedulePerformanceField = document.getElementById("schedulePerformance");
        let costPerformanceField = document.getElementById("costPerformance");

        function updateProjectDetails(projectId) {
            fetch(`/dashboard/{{ user.id }}?project_id=${projectId}`, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(response => response.json())
            .then(data => {
                // Update project details dynamically
                statusField.value = data.status;
                costField.textContent = `$${data.cost}`;
                projectNameField.textContent = data.name;
                startDateField.textContent = data.start_date;
                endDateField.textContent = data.end_date;
                budgetUtilizationField.textContent = `${data.budget_utilization}%`;
                schedulePerformanceField.textContent = data.schedule_performance;
                costPerformanceField.textContent = data.cost_performance;

                // Update other elements dynamically (if needed)
                // For example, updating another part of the page with this data
                // This is where you can extend functionality to update other components
                // or use this data elsewhere on the page.
            });
        }

        dropdown.addEventListener("change", function () {
            let selectedProjectId = dropdown.value;
            updateProjectDetails(selectedProjectId);
        });

        // Load initial project details on page load (default project)
        if (dropdown.value) {
            updateProjectDetails(dropdown.value);
        }
    });
</script>

 <!-- Guage  Script -->
<script>
    function createGauge(id, title, color, valueElement) {
        return new JustGage({
            id: id,                  
            value: 0,                
            min: 0,                  
            max: 2,                  
            title: title,            
            label: "",               
            gaugeWidthScale: 1,      
            pointer: true,           
            pointerOptions: {
                toplength: -20,       
                bottomlength: 30,     
                offsetY: 0            
            },
            levelColors: [color],    
            customSectors: [{        
                color: color,
                lo: 0, hi: 2
            }],
            decimals: 1,             
            valueFontColor: "#000",  
            labelFontColor: "#000",  
            textRenderer: function(value) { 
                document.getElementById(valueElement).innerText = value.toFixed(1);
                return value.toFixed(1); 
            }
        });
    }

    // Initialize the gauges
    var scheduleGauge = createGauge("schedule-gauge", "Schedule Performance", "#5bc0de", "schedulePerformance");
    var costGauge = createGauge("cost-gauge", "Cost Performance", "#d9534f", "costPerformance");

    // Function to update the gauges based on span values
    function updateGauges() {
        const schedulePerformance = parseFloat(document.getElementById("schedulePerformance").innerText) || 0;
        const costPerformance = parseFloat(document.getElementById("costPerformance").innerText) || 0;

        scheduleGauge.refresh(schedulePerformance);
        costGauge.refresh(costPerformance);
    }

    // Update gauges after initial delay
    setTimeout(updateGauges, 500);

    // Event Listener for Dropdown Selection
    document.getElementById("projectDropdown").addEventListener("change", function () {
        // Simulate fetching new values from backend when a project is selected
        setTimeout(updateGauges, 500); // Update gauges after a short delay
    });
</script>


 <!-- BarChart Script -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var userId = "{{ user.id }}"; // Ensure userId is globally available
        let barChart; // Separate variable for the bar chart

        function updateBarChart(taskCounts) {
            console.log("Updating Bar Chart with:", taskCounts); // Debugging

            const barCanvas = document.getElementById('barChart');
            if (!barCanvas) {
                console.error("❌ Bar Chart canvas not found!");
                return;
            }

            const ctx = barCanvas.getContext('2d');
            if (!ctx) {
                console.error("❌ Failed to get 2D context for barChart!");
                return;
            }

            if (barChart) {
                barChart.destroy(); // Destroy previous instance before creating a new one
            }

            // Define task categories and corresponding colors
            const taskLabels = ["High Priority", "Medium Priority", "Low Priority", "Completed", "In Progress", "Pending"];
            const taskData = [
                taskCounts.high_priority || 0,
                taskCounts.medium_priority || 0,
                taskCounts.low_priority || 0,
                taskCounts.completed || 0,
                taskCounts.in_progress || 0,
                taskCounts.pending || 0
            ];
            const taskColors = ["#e63946", "#f4a261", "#2a9d8f", "#264653", "#1d3557", "#457b9d"];

            // Create new bar chart
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: taskLabels,
                    datasets: [{
                        label: "Task Counts",
                        data: taskData,
                        backgroundColor: taskColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            console.log("✅ Bar Chart Updated!");
        }

        // ✅ Fetch data and update the bar chart
        function fetchAndUpdateBarChart(projectId) {
            fetch(`/dashboard/${userId}/?project_id=${projectId}`, { 
                headers: { "X-Requested-With": "XMLHttpRequest" } 
            })
            .then(response => response.json())
            .then(data => {
                if (data.task_counts) {
                    updateBarChart(data.task_counts);
                } else {
                    console.error("No task count data received!");
                }
            })
            .catch(error => console.error("Error fetching task count data:", error));
        }

        // 🟢 Event Listener for Project Dropdown
        document.getElementById("projectDropdown").addEventListener("change", function () {
            const projectId = this.value;
            if (projectId) {
                fetchAndUpdateBarChart(projectId);
            }
        });

        // ✅ Load Initial Data on Page Load
        setTimeout(() => {
            let firstProject = document.getElementById("projectDropdown")?.value;
            if (firstProject) {
                fetchAndUpdateBarChart(firstProject); // Load bar chart on dashboard page load
            } else {
                console.warn("⚠️ No project found in dropdown.");
            }
        }, 50); // Delay to ensure DOM is fully loaded
    });

</script>


  <!-- DonutChart Script -->
<script>
   document.addEventListener("DOMContentLoaded", function () {
    var userId = "{{ user.id }}";
    let donutChart; // Store chart instance globally

    function updateDashboard(projectId) {
        fetch(`/dashboard/${userId}/?project_id=${projectId}`, { 
            headers: { "X-Requested-With": "XMLHttpRequest" } 
        })
        .then(response => response.json())
        .then(data => {
            console.log("Received Data:", data); // Debugging

            if (!data || Object.keys(data).length === 0) {
                console.error("No valid data received!");
                return;
            }

            document.getElementById("projectName").innerText = data.name;
            document.getElementById("budgetUtilization").innerText = data.budget_utilization + "%";
            document.getElementById("schedulePerformance").innerText = data.schedule_performance;
            document.getElementById("costPerformance").innerText = data.cost_performance;

            if (data.resources && data.resources.labels.length > 0) {
                updateDonutChart(data.resources);
                updateResourceTable(data.resources);
            } else {
                console.error("No resource data available!");
            }
        })
        .catch(error => console.error("Error fetching data:", error));
    }

    function updateDonutChart(resourceData) {
        console.log("Resource Data for Chart:", resourceData); // Debugging

        const ctx = document.getElementById('donutChart')?.getContext('2d');

        if (!ctx) {
            console.error("Canvas element #donutChart not found!");
            return;
        }

        // Destroy previous chart before creating a new one
        if (donutChart) {
            donutChart.destroy();
        }

        donutChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: resourceData.labels,
                datasets: [{
                    data: resourceData.costs,
                    backgroundColor: resourceData.colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        console.log("Chart Updated Successfully!");
    }

    function updateResourceTable(resourceData) {
        const tableBody = document.querySelector("#resourceTable tbody");
        tableBody.innerHTML = ""; // Clear previous rows

        resourceData.labels.forEach((label, index) => {
            let row = `<tr>
                <td style="background-color: ${resourceData.colors[index]}; width: 20px;"></td>
                <td>${label}</td>
                <td>$${resourceData.costs[index].toLocaleString()}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        console.log("Table Updated Successfully!");
    }

    // Ensure project dropdown updates dashboard
    document.getElementById("projectDropdown").addEventListener("change", function () {
        updateDashboard(this.value);
    });

    // Run on page load to initialize first project
    let firstProject = document.getElementById("projectDropdown").value;
    if (firstProject) {
        updateDashboard(firstProject);
    }
});

 </script>



 <!-- PieChart Script -->
<script>
    let taskPieChart = null;
    var userId = "{{ user.id }}";  

    function fetchTaskData(projectId) {
        if (!projectId) {
            console.warn("⚠️ No project ID selected!");
            return;
        }

        fetch(`/dashboard/${userId}/?project_id=${projectId}`, {
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(response => response.json())
        .then(data => {
            console.log("✅ Received task data:", data);

            if (data.tasks && data.tasks.labels.length > 0) {
                updateTaskPieChart(data.tasks);
            } else {
                console.warn("⚠️ No task data available!");
                clearTaskChart();
            }
        })
        .catch(error => console.error("❌ Error fetching task data:", error));
    }

    function updateTaskPieChart(taskData) {
        const ctxPie = document.getElementById('taskPieChart').getContext('2d');

        if (taskPieChart) {
            taskPieChart.destroy();
        }

        taskPieChart = new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: taskData.labels,
                datasets: [{
                    data: taskData.days,
                    backgroundColor: taskData.colors, 
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                }
            }
        });

        updateTaskLegend(taskData.labels, taskData.colors);
    }

    function updateTaskLegend(labels, colors) {
        const legendContainer = document.getElementById('taskPieLegend');

        if (!legendContainer) {
            console.error("❌ taskPieLegend container not found in HTML!");
            return;
        }

        legendContainer.innerHTML = "";

        labels.forEach((label, index) => {
            let legendItem = document.createElement('div');
            legendItem.classList.add('d-flex', 'align-items-center', 'mx-2');

            let colorCircle = document.createElement('span');
            colorCircle.style.width = '12px';
            colorCircle.style.height = '12px';
            colorCircle.style.backgroundColor = colors[index];
            colorCircle.style.borderRadius = '50%';
            colorCircle.style.display = 'inline-block';
            colorCircle.style.marginRight = '8px';

            let labelText = document.createElement('span');
            labelText.innerText = label;
            labelText.style.fontSize = '14px';

            legendItem.appendChild(colorCircle);
            legendItem.appendChild(labelText);
            legendContainer.appendChild(legendItem);
        });
    }

    function clearTaskChart() {
        if (taskPieChart) {
            taskPieChart.destroy();
            taskPieChart = null;
        }
        const legendContainer = document.getElementById('taskPieLegend');
        if (legendContainer) {
            legendContainer.innerHTML = "<p>No task data available.</p>";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const projectDropdown = document.getElementById('projectDropdown');

        if (projectDropdown) {
            // Load the first project on page load
            let firstProject = projectDropdown.value;
            if (firstProject) {
                fetchTaskData(firstProject);
            }

            projectDropdown.addEventListener('change', function () {
                fetchTaskData(this.value);
            });
        } else {
            console.error("❌ projectDropdown element not found!");
        }
    });
</script>


 <!-- LineChart Script -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        fetch(`/budget_utilization/${userId}/`)  // Call your Django view
            .then(response => response.json())
            .then(data => {
                console.log("Budget Data:", data); // Debugging

                const budgetData = data.budget_data;
                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                
                const datasets = []; // Store project data for chart
                
                // Assign colors for each project dynamically
                const colors = ["#ff6384", "#36a2eb", "#ffce56", "#2a9d8f", "#e63946", "#f4a261"];

                let colorIndex = 0;
                for (let projectName in budgetData) {
                    const monthlyData = budgetData[projectName];

                    // Create an array with total cost per month (fill missing months with 0)
                    const costArray = months.map((_, index) => monthlyData[index + 1] || 0);

                    datasets.push({
                        label: projectName,
                        data: costArray,
                        borderColor: colors[colorIndex % colors.length], // Cycle colors
                        backgroundColor: "transparent",
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: colors[colorIndex % colors.length],
                        pointRadius: 4
                    });

                    colorIndex++;
                }

                // Create the Line Chart
                const ctxLine = document.getElementById("lineChart").getContext("2d");
                new Chart(ctxLine, {
                    type: "line",
                    data: {
                        labels: months,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: "top"
                            },
                            tooltip: {
                                enabled: true,
                                mode: "index"
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: "Months"
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "Total Cost ($)"
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error("Error fetching budget utilization:", error));
    });
</script>
  <!--   Core JS Files   -->
  <script src="{% static 'popper.min.js' %}" ></script>
   <script src="{% static 'bootstrap.min.js' %}" ></script>
   <script src="{% static 'perfect-scrollbar.min.js' %}" ></script>
   <script src="{% static 'smooth-scrollbar.min.js' %}" ></script>
   <script src="{% static 'chartjs.min.js' %}" ></script>
  
  <script>
    var ctx = document.getElementById("chart-bars").getContext("2d");

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["M", "T", "W", "T", "F", "S", "S"],
        datasets: [{
          label: "Views",
          tension: 0.4,
          borderWidth: 0,
          borderRadius: 4,
          borderSkipped: false,
          backgroundColor: "#43A047",
          data: [50, 45, 22, 28, 50, 60, 76],
          barThickness: 'flex'
        }, ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              borderDash: [5, 5],
              color: '#e5e5e5'
            },
            ticks: {
              suggestedMin: 0,
              suggestedMax: 500,
              beginAtZero: true,
              padding: 10,
              font: {
                size: 14,
                lineHeight: 2
              },
              color: "#737373"
            },
          },
          x: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false,
              borderDash: [5, 5]
            },
            ticks: {
              display: true,
              color: '#737373',
              padding: 10,
              font: {
                size: 14,
                lineHeight: 2
              },
            }
          },
        },
      },
    });


    var ctx2 = document.getElementById("chart-line").getContext("2d");

    new Chart(ctx2, {
      type: "line",
      data: {
        labels: ["J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"],
        datasets: [{
          label: "Sales",
          tension: 0,
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: "#43A047",
          pointBorderColor: "transparent",
          borderColor: "#43A047",
          backgroundColor: "transparent",
          fill: true,
          data: [120, 230, 130, 440, 250, 360, 270, 180, 90, 300, 310, 220],
          maxBarThickness: 6

        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              title: function(context) {
                const fullMonths = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                return fullMonths[context[0].dataIndex];
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              borderDash: [4, 4],
              color: '#e5e5e5'
            },
            ticks: {
              display: true,
              color: '#737373',
              padding: 10,
              font: {
                size: 12,
                lineHeight: 2
              },
            }
          },
          x: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false,
              borderDash: [5, 5]
            },
            ticks: {
              display: true,
              color: '#737373',
              padding: 10,
              font: {
                size: 12,
                lineHeight: 2
              },
            }
          },
        },
      },
    });

    var ctx3 = document.getElementById("chart-line-tasks").getContext("2d");

    new Chart(ctx3, {
      type: "line",
      data: {
        labels: ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        datasets: [{
          label: "Tasks",
          tension: 0,
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: "#43A047",
          pointBorderColor: "transparent",
          borderColor: "#43A047",
          backgroundColor: "transparent",
          fill: true,
          data: [50, 40, 300, 220, 500, 250, 400, 230, 500],
          maxBarThickness: 6

        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              borderDash: [4, 4],
              color: '#e5e5e5'
            },
            ticks: {
              display: true,
              padding: 10,
              color: '#737373',
              font: {
                size: 14,
                lineHeight: 2
              },
            }
          },
          x: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false,
              borderDash: [4, 4]
            },
            ticks: {
              display: true,
              color: '#737373',
              padding: 10,
              font: {
                size: 14,
                lineHeight: 2
              },
            }
          },
        },
      },
    });
  </script>
  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="{% static 'material-dashboard.min.js' %}" ></script>
</body>

</html>